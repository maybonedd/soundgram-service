# SOUNDGRAM

Микросервис на **FastAPI**, предназначенный для извлечения и нормализации данных о плейлистах Яндекс Музыки. Сервис поддерживает старый и новый форматы ссылок, извлекает информацию о треках и генерирует код для встраивания плеера.

## Структура проекта

* `app/main.py` — Точка входа, настройка путей и эндпоинты API.
* `app/clients/yandex.py` — Асинхронный клиент для взаимодействия с внешним API.
* `app/schemas/playlist.py` — Pydantic-модели (схемы) для валидации ответов.
* `app/core/utils.py` — Регулярные выражения для парсинга ссылок и форматирование данных.

---

## Запуск

### С использованием venv:

1. Клонируйте репозиторий.
2. Создайте виртуальное окружение:
```bash
python -m venv venv
source venv/bin/activate  # Для Windows: venv\Scripts\activate

```


3. Установите зависимости:
```bash
pip install -r requirements.txt.txt

```


4. Запустите сервис:
```bash
uvicorn app.main:app --reload

```


5. Откройте Swagger UI: `http://127.0.0.1:8000/docs`

---

## Описание API

### `GET /api/v1/playlist`

Извлекает данные о плейлисте по его URL.

**Параметры:**

* `url` (string, required): Ссылка на плейлист.

**Пример ответа:**

```json
{
  "title": "Плейлист дня",
  "owner": "yandex_music",
  "tracks": [
    {
      "title": "Название трека",
      "artists": ["Имя артиста"],
      "cover_url": "https://avatars.yandex.net/get-music-content/...",
      "iframe_code": "<iframe ... src=\"https://music.yandex.ru/iframe/album/123/track/456\"></iframe>"
    }
  ]
}

```

---

## Допущения и краевые случаи

### Поддерживаемые форматы

1. **Старый формат:** `https://music.yandex.ru/users/{owner}/playlists/{kind}`
* Используется внутренний хендлер `playlist.jsx`.


2. **Новый формат:** `https://music.yandex.ru/playlists/{kind}`
* Используется API эндпоинт `api.music.yandex.by`.
* *Допущение:* `kind` в новом формате всегда является числовым идентификатором.



### Обработка ошибок и устойчивость

* **404 / Приватность:** Если плейлист удален или закрыт настройками приватности, сервис возвращает `404 Not Found` с понятным описанием.
* **Таймауты:** Установлен лимит в 10 секунд на запрос к Яндексу. При превышении сервис отдает `504 Gateway Timeout`.
* **User-Agent:** Для предотвращения блокировок со стороны Яндекса (анти-бот) используются заголовки реального браузера.
* **Невалидные треки:** Если в плейлисте есть недоступные треки (missing/error), сервис их пропускает, возвращая только валидный контент.

### "Неофициальные" моменты

* Используются внутренние API Яндекса, так как официальное публичное API ограничено.
* Риск поломки снижен за счет **изоляции логики парсинга** в отдельном клиенте: если формат ответа изменится, правки потребуются только в `YandexMusicClient`.

---



## Примеры использования

### Стандартный запрос (Работает стабильно)

Используйте ссылки на публичные или системные плейлисты с цифровым ID.

* **Пример URL:** `https://music.yandex.ru/users/yamusic-daily/playlists/1060`
* **Действие:** Перейдите в Swagger, вызовите эндпоинт `/api/v1/playlist` и вставьте ссылку в параметр `url`.

### Ограничение для UUID-ссылок

При попытке запроса по ссылкам с длинным UUID (например, персональные подборки):

* **Пример URL:** `https://music.yandex.ru/playlists/479652a7-a86f-6770-3cbd-e1e0ac9600f1`
* **Результат:** Ошибка `502 Bad Gateway`.
* **Причина:** Данные плейлисты являются динамическими и защищены со стороны Яндекс Музыки. Для их получения требуется авторизация пользователя (Session_id/Cookies), что выходит за рамки текущего MVP.

---


